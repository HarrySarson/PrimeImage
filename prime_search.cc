#include <iostream>
#include <string>
#include <gmp.h>
#include <random>
#include <algorithm>

char get_tweaked_char(char c) {
	switch(c) {
		case '0' : return '8'; break;
		case '1' : return '7'; break;
		case '2' : return '5'; break;
		case '3' : return '4'; break;
		case '4' : return '3'; break;
		case '5' : return '2'; break;
		case '6' : return '9'; break;
		case '7' : return '1'; break;
		case '8' : return '0'; break;
		case '9' : return '6'; break;
	}
}

void tweak_string(std::string &s, int i) {
	s[i] = get_tweaked_char(s[i]);
}

int miller_rabin(std::string img, int reps) {
	mpz_t n;
	mpz_init(n);
	mpz_set_str(n, img.c_str(), 10); // read from string as base 10
	return mpz_probab_prime_p(n, reps);
}

int comb(std::string& img, int K) {
	int N = img.length();
    std::string bitmask(K, 1); // K leading 1's
    bitmask.resize(N, 0); // N-K trailing 0's

    // print integers and permute bitmask
    do {
		std::string mod_img(img);
        for (int i = 0; i < N; ++i) {// [0..N-1] integers
            if (bitmask[i]) tweak_string(mod_img, i);
        }
		int res = miller_rabin(mod_img, 8);
		if (res != 0) {
			swap(mod_img, img);
			return res;
		}
    } while (std::prev_permutation(bitmask.begin(), bitmask.end()));
	return 0;
}

std::string find_candidate(std::string& img) {
	for(int i = 0; i<img.length(); i++) {
		if (comb(img, i) != 0) break;
	}
	std::cout << "candidate found!" << std::endl;
	std::cout << img << std::endl;
}

int main() {
	// Corpus Christi Prime test placeholder
	std::string img = "100101077777777777777077777777777777777777077777777777777777777710100107777777777777020777777777777777777020777777777777777777771001000777777777777770777777777777777777770777777777777777777777777777777777777777770507777777777777777770507777777777777777777777777777777777777770551077777777777777770155077777777777777777777777777777777777777055507777777777777777055507777777777777777777777777777777777777700003777777700777777730000777777777777777777777777777777777777704333077777708807777770333407777777777777777777777777777777777777000007777771001777777000007777777777777777777777777707777777777709990777771055017777709990777777777770777777777777770177777777770999077771055550177770999077777777771077777777777777047777777777099907717053003507177100007777777777407777777777777010777777777700080050051111115005008000777777777701077777777777701077777777771099000511000000115000999077777777770107777777777777247777777777000001115051111605111001007777777777327777777777777700777777777709930150011500511005103990777777777700777777777777770777777777710993000111108801111000399017777777777077777777777777047777777700000001111115005111112000000077777777407777777700070056011001105505990111111111111111109950550110011065007000706560655550055005550090011111160051111110090055500550055556065605555555555555555555009001115088988805111009005555555555555555555000000550000000000009090111908888880911109090000000000005500000011111055011111111110909011108888888801110909011111111110550111119511105501115995111090901118008008008111090901115995111055011159085110550116800851103030111888888888811103030115900851206501158008011000011080080110535011188888888891110535011080080110000110800801105501108008010900001118888888888111000090108018011055011080080210550110800801105550111000033000011105650110800801105501108008011055011080080110595034000000000999330595011080080110550110803331105501133333311093305555655555555555033901133333312055011333000000550000000000009590999999999999999909590000000000005500000011115055051111111110949011111121111111110949011111111150550511111111105501111111111092901119000100009111092901111111111055011112111110000111111211109590121088898888011109590111111111100001111185111055011158911110959011108008800801111959011119851110550111580051106501150008111092901110088888800111092901118000511055011500083110550113808011005590111018888880011109550011080831105501138008311055011380801105555501100888888001105555501108083110560113900031105611130000110555550110088888800110555550110000311055011300111105555011111111055555011008888880011055555011111111055550111211110555501111111105555501100888888001105555501111111105500000000000055550000000000555550000088888800000555550000000000550120397";
	find_candidate(img);

}
