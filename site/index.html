---
---

<html>

<head>
  <meta charset="utf-8"/>
  <title>Prime Image</title>
  <link rel="stylesheet" href="main.css"/>
</head>

<body>

    <script type="text/javascript" src="built/elm.js"></script>

    <script type="text/javascript">
      const app = Elm.Main.fullscreen();


      app.ports.fileSelected.subscribe(function (id) {
        var element = document.getElementById(id);
        if (element === null) {
          return;
        }

        var file = element.files[0];
        var reader = new FileReader();

        reader.onload = (function(event) {
          // The result is base64 encoded contents of the file.
          var base64encoded = event.target.result;

          var portData = {
            contents: base64encoded,
            filename: file.name
          };

          app.ports.fileContentRead.send(portData);
        });

        // Connect our FileReader with the file that was selected in our `input` node.
        reader.readAsDataURL(file);
      });


      app.ports.requestNonPrime.subscribe(({ toNumberConfig, image }) => {
        const {
          width: { value: width },
          height: { value: height },
          levels: errorableLevels,
        } = toNumberConfig;

        const levels = errorableLevels.map(x => x.value);

        const val = new Uint8Array(width * height);

        for (let i = 0; i < val.length; ++i) {
          val[i] = Math.floor(Math.random() * 3);
        }

        app.ports.nonPrimeGenerated.send({
          number: val.join(''),
          width,
        });
      });

      app.ports.setInitialValues.subscribe(({ width, height, levels }) => {
        let delayCount = 0;
        requestAnimationFrame(function updateDom() {
          const getInput = name =>
            document.querySelector(`.to-number-config-input[data-input-name="${name}"]`);

          const $width = getInput('width');

          if ($width == null) {
            delayCount = delayCount + 1;

            if (delayCount > 5) {
              console.error(`Could not set initial number config values. Given up.`);
            } else {
              console.log(`delaying setting of initial number config values ${delayCount} times`);
              requestAnimationFrame(updateDom);
            }
          } else {

            const $height = getInput('height');

            const $levels = [...(function* () {
              let $level;
              let i = 1;
              while(($level = getInput(`level ${i}`)) != null) {
                yield $level;
                ++i;
              }
            })()];

            $width.value = width.attemptedValue;
            $height.value = height.attemptedValue;

            const numLevels = Math.min($levels.length, levels.length);

            for (let i = 0; i < numLevels; ++i) {
              $levels[i].value = levels[i].attemptedValue
            }
          }
        });
      });

      app.ports.ppState.subscribe(state => {
        console.log(state);
      });

    </script>

</body>

</html>
