---
---

<html>

<head>
  <meta charset="utf-8" />
  <link rel="stylesheet" href="main.css" />


  <script type=module>
  import { Elm } from './built/elm.js';
  import { getImageData, quantise } from './js/create-non-prime.js';
  import { GreyImageData } from './js/grey-image-data.js';
  import debounce from 'https://unpkg.com/lodash-es@4.17.11/debounce';
  import { resizeText } from './js/resize-text.js';
  import { runWhen } from './js/run-when.js';


  const app = Elm.Main.init();


  app.ports.logError.subscribe(function (description) {
    console.error(description);
  });

  app.ports.requestPrime.subscribe(async ([endPoint, nonPrime]) => {
    try {
      const response = await fetch(endPoint, {
        method: 'POST',
        body: nonPrime,
      });

      if (response.status >= 200 && response.status <= 300) {
        const text = await response.text();

        app.ports.probablyPrimeGenerated.send(text);
      } else {
        app.ports.requestPrimeError.send(`Invalid response status: ${response.status}`);
      }

    } catch (e) {
      app.ports.requestPrimeError.send(`${e}`);
    }
  });

  app.ports.requestNonPrime.subscribe(debounce(async ({ toNumberConfig, image }) => {
    const {
      width: { value: width },
      levels: errorableLevels,
    } = toNumberConfig;

    const numberLookup = [8, 6, 5, 7];

    const levels = errorableLevels.map(x => x.value);

    if (levels.length + 1 !== numberLookup.length) {
      app.ports.nonPrimeError.send(
        `Incorrect number of levels (${levels.length}), expected ${numberLookup.length}`,
      );
      return;
    }
    let number;
    try {
      const color = await getImageData(image.contents, width);
      const grey = GreyImageData.fromColorImage(color);
      const quantised = quantise(grey.data, new Uint8Array(grey.data.length), levels);
      number = quantised.map(x => numberLookup[x]);
    } catch (e) {
      app.ports.nonPrimeError.send(`${e}`);
      return;
    }

    app.ports.nonPrimeGenerated.send(number.join(''));
  }), 100);


  app.ports.setCssProp.subscribe(([selector, prop, value]) => {
    for (const $el of document.querySelectorAll(selector)) {
      $el.style.setProperty(prop, value);
    }
  });

  /* Automatic text resizing */

  function resizeAllTexts() {
    for (let node of document.querySelectorAll('.auto-resize')) {
      resizeText(node);
    }
  }

  (async () => {
    try {
      await runWhen(() => document.querySelector('.display-panel') != null, 5);
    } catch (e) {
      console.log(`Given up trying to automatically resize image number text due to error:\n${e}`);
      return;
    }

    resizeAllTexts();

  })();

  window.addEventListener('resize', debounce(resizeAllTexts, 200));

  app.ports.resizeImageNumber.subscribe(() => {
    requestAnimationFrame(resizeAllTexts);
  });

</script>

</head>

<body>
</body>

</html>
